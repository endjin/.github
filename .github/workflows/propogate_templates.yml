name: propogate_templates
on: 
  workflow_dispatch:

env:
  ORGS: menes-dotnet,corvus-dotnet

jobs:
  sync_templates_to_orgs:
    # only run in the source organisation
    if: |
      github.repository_owner == 'endjin'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
      shell: bash
      env:
        SSH_PRIVATE_KEY: ${{ secrets.ENDJIN_BOT_PRIVATE_KEY }}
    - run: |
        echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
        $orgs = "${{ env.ORGS }}" -split ','
        try {
          ./sync-repo-to-orgs.ps1 -Organisations $orgs
        }
        finally {
          rm ~/.ssh/id_rsa
        }
      shell: pwsh
      
